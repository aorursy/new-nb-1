"""

This is based on Lingzhi's upgraded version 

  (https://www.kaggle.com/vrtjso/lgbm-one-step-ahead)

of Ceshine's LGBM starter script

  (https://www.kaggle.com/ceshine/lgbm-starter),



but it is just the data preparation steps,

so we don't have to repeat them every time.

"""



from datetime import date, timedelta



import pandas as pd

import numpy as np

from sklearn.metrics import mean_squared_error

import lightgbm as lgb
df_train = pd.read_csv(

    '../input/train.csv', usecols=[1, 2, 3, 4, 5],

    dtype={'onpromotion': bool},

    converters={'unit_sales': lambda u: np.log1p(

        float(u)) if float(u) > 0 else 0},

    parse_dates=["date"],

    skiprows=range(1, 66458909)  # 2016-01-01

)



df_test = pd.read_csv(

    "../input/test.csv", usecols=[0, 1, 2, 3, 4],

    dtype={'onpromotion': bool},

    parse_dates=["date"]  # , date_parser=parser

).set_index(

    ['store_nbr', 'item_nbr', 'date']

)



items = pd.read_csv(

    "../input/items.csv",

).set_index("item_nbr")
df_2017 = df_train.loc[df_train.date>=pd.datetime(2017,1,1)]

del df_train
promo_2017_train = df_2017.set_index(

    ["store_nbr", "item_nbr", "date"])[["onpromotion"]].unstack(

        level=-1).fillna(False)

promo_2017_train.columns = promo_2017_train.columns.get_level_values(1)

promo_2017_test = df_test[["onpromotion"]].unstack(level=-1).fillna(False)

promo_2017_test.columns = promo_2017_test.columns.get_level_values(1)

promo_2017_train = promo_2017_train.reindex(promo_2017_test.index).fillna(False)

promo_2017 = pd.concat([promo_2017_train, promo_2017_test], axis=1)

del promo_2017_test, promo_2017_train
df_2017 = df_2017.set_index(

    ["store_nbr", "item_nbr", "date"])[["unit_sales"]].unstack(

        level=-1).fillna(0)

df_2017.columns = df_2017.columns.get_level_values(1)



items = items.reindex(df_2017.index.get_level_values(1))
print(df_2017.shape)

df_2017.head()
test_all = df_test[[]].reset_index()

store_by_item = test_all[test_all.date==pd.to_datetime('2017-08-16')].drop(['date'],axis=1)

del test_all

print(store_by_item.shape)

store_by_item.head()
df_2017 = store_by_item.join(df_2017,on=['store_nbr','item_nbr']).set_index(df_2017.index.names).fillna(0)

print(df_2017.shape)

df_2017.head()
def get_timespan(df, dt, minus, periods, freq='D'):

    return df[pd.date_range(dt - timedelta(days=minus), periods=periods, freq=freq)]



def prepare_dataset(t2017, is_train=True):

    X = pd.DataFrame({

        "day_1_2017": get_timespan(df_2017, t2017, 1, 1).values.ravel(),

        "mean_3_2017": get_timespan(df_2017, t2017, 3, 3).mean(axis=1).values,

        "mean_7_2017": get_timespan(df_2017, t2017, 7, 7).mean(axis=1).values,

        "mean_14_2017": get_timespan(df_2017, t2017, 14, 14).mean(axis=1).values,

        "mean_30_2017": get_timespan(df_2017, t2017, 30, 30).mean(axis=1).values,

        "mean_60_2017": get_timespan(df_2017, t2017, 60, 60).mean(axis=1).values,

        "mean_140_2017": get_timespan(df_2017, t2017, 140, 140).mean(axis=1).values,

        "promo_14_2017": get_timespan(promo_2017, t2017, 14, 14).sum(axis=1).values,

        "promo_60_2017": get_timespan(promo_2017, t2017, 60, 60).sum(axis=1).values,

        "promo_140_2017": get_timespan(promo_2017, t2017, 140, 140).sum(axis=1).values

    })

    for i in range(7):

        X['mean_4_dow{}_2017'.format(i)] = get_timespan(df_2017, t2017, 28-i, 4, freq='7D').mean(axis=1).values

        X['mean_20_dow{}_2017'.format(i)] = get_timespan(df_2017, t2017, 140-i, 20, freq='7D').mean(axis=1).values

    for i in range(16):

        X["promo_{}".format(i)] = promo_2017[

            t2017 + timedelta(days=i)].values.astype(np.uint8)

    if is_train:

        y = df_2017[

            pd.date_range(t2017, periods=16)

        ].values

        return X, y

    return X
t2017 = date(2017, 5, 31)

X_l, y_l = [], []

for i in range(6):

    delta = timedelta(days=7 * i)

    X_tmp, y_tmp = prepare_dataset(

        t2017 + delta

    )

    X_l.append(X_tmp)

    y_l.append(y_tmp)

X_train = pd.concat(X_l, axis=0)

y_train = np.concatenate(y_l, axis=0)

del X_l, y_l

X_val, y_val = prepare_dataset(date(2017, 7, 26))

X_test = prepare_dataset(date(2017, 8, 16), is_train=False)
X_train.to_csv('X_train.csv', float_format='%.6f', index=None)

pd.DataFrame(y_train).to_csv('y_train.csv', float_format='%.6f', index=None)

X_val.to_csv('X_val.csv', float_format='%.6f', index=None)

pd.DataFrame(y_val).to_csv('y_val.csv', float_format='%.6f', index=None)

X_test.to_csv('X_test.csv', float_format='%.6f', index=None)

pd.DataFrame(index=df_2017.index).to_csv('stores_items.csv')

df_test[['id']].to_csv('test_ids.csv')